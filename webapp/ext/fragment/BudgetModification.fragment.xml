<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:layout="sap.ui.layout"
>
    <layout:VerticalLayout
        width="100%"
        class="sapUiSmallMargin"
    >
        <!-- Title for the new block -->
        <Text
            text="Ce bloc permet de saisir des ajustements budgétaires sur des missions existantes validées."
            class="sapUiSmallMarginBottom"
        />

        <!-- Toolbar with Add button -->
        <Toolbar>
            <content>
                <Title
                    level="H3"
                    class="sapUiTinyMarginEnd"
                />
                <ToolbarSpacer />
                <Button
                    id="addModificationBtn"
                    icon="sap-icon://add"
                    text="Ajouter une ligne"
                    press="onAddBudgetModificationLine"
                    type="Emphasized"
                    enabled="{ui>/editable}"
                    class="sapUiTinyMarginBegin"
                />
            </content>
        </Toolbar>

        <!-- Budget Modification Table -->
        <Table
            id="budgetModificationTable"
            inset="true"
            growing="true"
            growingScrollToLoad="true"
            mode="None"
            items="{modifBudget>/results}"
        >
            <headerToolbar>
                <OverflowToolbar>
                    <Title
                        text="Ajustements budgétaires"
                        level="H3"
                    />
                    <ToolbarSpacer />
                    <Label text="Nombre de lignes:" />
                    <Text text="{= ${modifBudget>/results}.length }" />
                </OverflowToolbar>
            </headerToolbar>

            <columns>
                <Column width="120px">
                    <Text text="Date de création" />
                </Column>
                <Column width="180px">
                    <Text text="Mission émettrice" />
                </Column>
                <Column width="180px">
                    <Text text="Mission réceptrice" />
                </Column>
                <Column width="150px">
                    <Text text="Ajustement du budget" />
                </Column>
                <Column width="100px">
                    <Text text="Devise" />
                </Column>
                <Column width="80px">
                    <Text text="Actions" />
                </Column>
            </columns>

            <items>
                <ColumnListItem>
                    <cells>
                        <!-- Date de création (auto-filled) -->
                        <Text
                            text="{
                                path: 'modifBudget>DateCreation',
                                type: 'sap.ui.model.type.Date',
                                formatOptions: { pattern: 'yyyy-MM-dd' }
                            }"
                        />

                        <!-- Mission réceptrice (read-only) -->
                        <Text text="{modifBudget>Mission_e}" />

                        <!-- Mission émettrice (read-only) -->
                        <Text text="{modifBudget>Mission_p}" />

                        <!-- Budget adjustment input -->
                        <Input
                            value="{modifBudget>DeltaBudget}"
                            change="onBudgetAdjustmentChange"
                            enabled="{
                                parts: [
                                    { path: 'modifBudget>isNew' },
                                    { path: 'modifBudget>MissionPairId' }
                                ],
                                formatter: '.isModificationLineEditable'
                            }"
                            placeholder="Montant +/-"
                            type="Number"
                            width="100%"
                        />

                        <!-- Currency (auto-filled, read-only) -->
                        <Text text="{modifBudget>Devise}" />

                        <!-- Delete button -->
                        <Button
                            icon="sap-icon://delete"
                            type="Reject"
                            press="onDeleteBudgetModificationLine"
                            enabled="{
                                parts: [
                                    { path: 'modifBudget>isNew' },
                                    { path: 'modifBudget>MissionPairId' }
                                ],
                                formatter: '.isModificationLineEditable'
                            }"
                            tooltip="Supprimer cette ligne"
                        />
                    </cells>
                </ColumnListItem>
            </items>
        </Table>

        <!-- Information text -->
        <VBox class="sapUiSmallMarginTop">
            <Text
                text="Informations :"
                class="sapUiTinyMarginBottom"
            />
            <Text
                text="• Seules les missions validées (issues d'un formulaire approuvé) sont disponibles à la sélection"
                class="sapUiTinyMarginBottom"
            />
            <Text
                text="• La date de création est automatiquement remplie avec la date du jour"
                class="sapUiTinyMarginBottom"
            />
            <Text
                text="• La devise est reprise automatiquement depuis la mission réceptrice"
                class="sapUiTinyMarginBottom"
            />
            <Text
                text="• L'ajustement peut être positif (augmentation) ou négatif (diminution)"
                class="sapUiTinyMarginBottom"
            />
        </VBox>
    </layout:VerticalLayout>
</core:FragmentDefinition>
