<core:FragmentDefinition
    xmlns="sap.m"
    xmlns:core="sap.ui.core"
    xmlns:table="sap.ui.table"
    xmlns:layout="sap.ui.layout"
    xmlns:rm="sap.ui.table.rowmodes"
>
    <layout:VerticalLayout width="100%" >
        <!--Toolbar>
            <content>
                <ToolbarSpacer />
                <Button
                    icon="sap-icon://refresh"
                    text="Refresh"
                    press=".onRefreshTree"
                    type="Emphasized"
                />
            </content>
        </Toolbar-->
        <table:TreeTable
            id="missionsTreeTable"
            rows="{
                path: 'missions>/',
                parameters: {
                    arrayNames: ['children'],
                    numberOfExpandedLevels: 3
                }
            }"
            selectionMode="None"
            ariaLabelledBy="title"
            enableColumnReordering="false"
        >
            <table:rowMode>
                <rm:Auto
                    minRowCount="{localModel>/tableSettings/minRowCount}"
                />
            </table:rowMode>
            <table:columns>
                <!-- Hierarchy Column -->
                <table:Column width="18rem">
                    <Label text="Hierarchy" />
                    <table:template>
                        <HBox>
                            <Text
                                text="{= ${missions>type} === 'business' ? ${missions>BusinessNo} : 
                                      ${missions>type} === 'regroupement' ? ${missions>Regroupement} : 
                                      ${missions>MissionId}}"
                                class="{= ${missions>type} === 'business' ? 'sapUiLargeMarginBegin' : 
                                       ${missions>type} === 'regroupement' ? 'sapUiMediumMarginBegin' : 
                                       'sapUiSmallMarginBegin'}"
                            />
                        </HBox>
                    </table:template>
                </table:Column>

                <!-- Libellé Column -->
                <table:Column width="5rem">
                    <Label text="Mission" />
                    <table:template>
                        <Text
                            text="{missions>MissionCode}"
                            visible="{= ${missions>type} === 'mission'}"
                        />
                    </table:template>
                </table:Column>

                <!-- Description Column -->
                <table:Column width="11rem">
                    <Label text="Description" />
                    <table:template>
                        <Text
                            text="{missions>description}"
                            visible="{= ${missions>type} === 'mission'}"
                        />
                    </table:template>
                </table:Column>

                <!-- Regroupement Column -->
                <table:Column width="7rem">
                    <Label text="Regroupement" />
                    <table:template>
                        <Text
                            text="{missions>Regroupement}"
                            visible="{= ${missions>type} === 'mission'}"
                        />
                    </table:template>
                </table:Column>

                <!-- Status Column -->
                <table:Column width="5rem">
                    <Label text="Status" />
                    <table:template>
                        <Text
                            text="{missions>statutmission}"
                            visible="{= ${missions>type} === 'mission'}"
                        />
                    </table:template>
                </table:Column>

                <!-- Budget global (recette) Column -->
                <table:Column width="8rem">
                    <Label text="Budget global" />
                    <table:template>
                        <ObjectNumber
                            number="{missions>GlobalBudget}"
                            unit="EUR"
                            visible="{= ${missions>type} === 'mission'}"
                            state="None"
                        />
                    </table:template>
                </table:Column>

                <!-- Budget déjà en STI Column -->
                <table:Column width="8rem">
                    <Label text="Budget STI" />
                    <table:template>
                        <ObjectNumber
                            number="{missions>BudgetInSTI}"
                            unit="EUR"
                            visible="{= ${missions>type} === 'mission'}"
                            state="None"
                            tooltip="{= 'Original: ' + ${missions>OriginalBudget} + ' EUR | Draft: ' + ${missions>BudgetInSTI} + ' EUR'}"

                        />
                    </table:template>
                </table:Column>

                <!-- Budget disponible Column -->
                <table:Column width="8rem">
                    <Label text="Budget disponible" />
                    <table:template>
                        <ObjectNumber
                            number="{missions>AvailableBudget}"
                            unit="EUR"
                            visible="{= ${missions>type} === 'mission'}"
                            state="{= parseFloat(${missions>AvailableBudget}) > 0 ? 'Success' : 'Error'}"
                        />
                    </table:template>
                </table:Column>

                <!-- Pourcentage Budget sous-traité Column -->
                <table:Column width="15rem">
                    <Label text="% Sous-traité" />
                    <table:template>
                        <ProgressIndicator
                            displayValue="{missions>SubcontractedBudgetPercentage}"
                            percentValue="{= parseFloat(${missions>SubcontractedBudgetPercentage}) || 0}"
                            visible="{= ${missions>type} === 'mission'}"
                            state="{= parseFloat(${missions>SubcontractedBudgetPercentage}) > 80 ? 'Error' : 
                                   parseFloat(${missions>SubcontractedBudgetPercentage}) > 50 ? 'Warning' : 'Success'}"
                            width="100%"
                        />
                    </table:template>
                </table:Column>

                <!-- Summary Columns for Parent Nodes -->

                <!-- Regroupement Summary -->
                <table:Column width="8rem">
                    <Label text="Total Regroupement" />
                    <table:template>
                        <ObjectNumber
            number="{= ${missions>type} === 'regroupement' ? ${missions>totalGlobalBudget} : ''}"
                            unit="EUR"
                            visible="{= ${missions>type} === 'regroupement'}"
                            state="None"
                        />
                    </table:template>
                </table:Column>

                <!-- BusinessNo Summary -->
                <table:Column width="8rem">
                    <Label text="Total Business" />
                    <table:template>
                        <ObjectNumber
            number="{= ${missions>type} === 'business' ? ${missions>totalGlobalBudget} : ''}"
                            unit="EUR"
                            visible="{= ${missions>type} === 'business'}"
                            state="None"
                        />
                    </table:template>
                </table:Column>

            </table:columns>
        </table:TreeTable>
    </layout:VerticalLayout>
</core:FragmentDefinition>