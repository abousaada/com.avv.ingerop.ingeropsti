<mvc:View
    xmlns:core="sap.ui.core"
    xmlns:mvc="sap.ui.core.mvc"
    xmlns="sap.m"
    xmlns:html="http://www.w3.org/1999/xhtml"
    xmlns:layout="sap.ui.layout"
    controllerName="com.avv.ingerop.ingeropsti.ext.controller.Budget"
>
    <layout:VerticalLayout width="100%">
        <Toolbar>
            <content>
                <ToolbarSpacer />
                <Button
                    id="addLineBtn"
                    icon="sap-icon://add"
                    text="Ajouter une ligne"
                    press="onAddBudgetLine"
                    type="Emphasized"
                    enabled="{
                        parts: [
                            { path: 'ui>/editable' },
                            { path: 'missions>/results' },
                            { path: 'ui>/isAvnant' }
                        ],
                        formatter: '.enableAddLine'
                    }"
                />
            </content>
        </Toolbar>

        <Table
            id="budgetTable"
            inset="false"
            growing="true"
            growingScrollToLoad="true"
            growingThreshold="99"
            mode="{= ${ui>/showModifBudget} ? 'SingleSelectLeft' : 'None' }"
            items="{budget>/results}"
        >
            <columns>
                <Column width="100px">
                    <Text text="Date de création" />
                </Column>
                <Column width="280px">
                    <Text text="Mission sous-traitée" />
                </Column>
                <Column width="230px">
                    <Text text="Mission associée" />
                </Column>
                <Column>
                    <Text text="Libellé" />
                </Column>
                <Column>
                    <Text text="MissionCode" />
                </Column>
                <Column>
                    <Text text="Regroupement" />
                </Column>
                <Column>
                    <Text text="Date de début" />
                </Column>
                <Column>
                    <Text text="Date de fin" />
                </Column>
                <Column>
                    <Text text="Budget sous-traité (recette)" />
                </Column>
                <Column>
                    <Text text="Devise" />
                </Column>
                <Column width="80px">
                    <Text text="Actions" />
                </Column>
            </columns>

            <items>
                <ColumnListItem>
                    <cells>
                        <Text 
                            text="{
                                path: 'budget>CreationDate',
                                type: 'sap.ui.model.type.Date',
                                formatOptions: { pattern: 'yyyy-MM-dd' }
                            }" />

                        
                        <Select
                            items="{
                                path: 'missions>/results',
                                templateShareable: false
                            }"
                            editable="{
                                parts: [
                                    { path: 'budget>isNew' },
                                    { path: 'budget>Mission_p' },
                                    { path: 'ui>/isAvnant' }
                                ],
                                formatter: '.formatCellEditable'
                            }"
                            selectedKey="{budget>Mission_e}"
                            change="onMissionChange"
                        >
                            <core:Item
                                key="{missions>MissionId}"
                                text="{missions>MissionId}"
                            />
                        </Select>

                        <Text text="{budget>Mission_p}" />

                        <Input
                            value="{budget>Libelle}"
                            editable="{
                                parts: [
                                    { path: 'budget>isNew' },
                                    { path: 'budget>Mission_p' },
                                    { path: 'ui>/isAvnant' }
                                ],
                                formatter: '.formatCellEditable'
                            }"
                        />

                        <Text text="{budget>MissionCode}" />
                        <Text text="{budget>Regroupement}" />

                        <DatePicker
                            value="{path: 'budget>StartDate', type: 'sap.ui.model.type.Date', formatOptions: { pattern: 'yyyy-MM-dd' }}"
                            displayFormat="short"
                            editable="{
                                parts: [
                                    { path: 'budget>isNew' },
                                    { path: 'budget>Mission_p' },
                                    { path: 'ui>/isAvnant' }
                                ],
                                formatter: '.formatCellEditable'
                            }"
                            width="100%"
                            required="true"
                        />

                        <DatePicker
                            value="{path: 'budget>EndDate', type: 'sap.ui.model.type.Date', formatOptions: { pattern: 'yyyy-MM-dd' }}"
                            displayFormat="short"
                            editable="{
                                parts: [
                                    { path: 'budget>isNew' },
                                    { path: 'budget>Mission_p' },
                                    { path: 'ui>/isAvnant' }
                                ],
                                formatter: '.formatCellEditable'
                            }"
                            width="100%"
                            required="true"
                        />

                        <Input
                            value="{budget>BudgetAlloue}"
                            editable="{
                                parts: [
                                    { path: 'budget>isNew' },
                                    { path: 'budget>Mission_p' },
                                    { path: 'ui>/isAvnant' }
                                ],
                                formatter: '.formatCellEditable'
                            }"
                            type="Number"
                            placeholder="0.00"
                        />

                        <Text text="{budget>Currency}" />

                        <Button
                            icon="sap-icon://delete"
                            type="Reject"
                            press="onDeleteBudgetLine"
                            enabled="{
                                parts: [
                                    { path: 'budget>isNew' },
                                    { path: 'budget>Mission_p' },
                                    { path: 'ui>/isAvnant' }
                                ],
                                formatter: '.formatCellEditable'
                            }"
                        />
                    </cells>
                </ColumnListItem>
            </items>
        </Table>
    </layout:VerticalLayout>

    <!-- New modifications in a separate panel -->
    <Panel
        id="modifBudgetPanel"
        expandable="true"
        expanded="true"
        headerText="Modification du budget"
        visible="{ui>/showModifBudget}"
    >
        <content>
            <core:Fragment
                fragmentName="com.avv.ingerop.ingeropsti.ext.fragment.BudgetModification"
                type="XML"
            />
        </content>
    </Panel>
</mvc:View>
